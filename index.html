<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCQ Quiz Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* General Body and Layout */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ccebff;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            width: 100%;
            background-color: #f8f8f8;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 2rem;
            box-sizing: border-box;
        }

        /* Header Styles */
        header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .title {
            font-size: 2.25rem;
            font-weight: 700;
            color: #1f2937;
        }
        .subtitle {
            margin-top: 0.5rem;
            color: #4b5563;
        }

        /* Input Section */
        .input-section {
            margin-bottom: 2rem;
        }
        .custom-textarea {
            width: 100%;
            min-height: 200px;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            transition-property: border-color, box-shadow;
            transition-duration: 200ms;
            resize: vertical;
        }
        .custom-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .generate-btn {
            width: 100%;
            background-color: #2563eb;
            color: #ffffff;
            font-weight: 600;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition-property: background-color;
            transition-duration: 200ms;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .generate-btn:hover {
            background-color: #1d4ed8;
        }
        .generate-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        /* Loading and Results */
        .status-container {
            display: none; /* Initially hidden */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100px;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #2563eb;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Quiz Container */
        .quiz-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 2rem;
        }
        .question-card {
            background-color: #f9fafb;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        .question-text {
            font-size: 1.125rem;
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        .option-btn {
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            color: #374151;
            background-color: #ffffff;
            cursor: pointer;
            transition-property: background-color, border-color;
            transition-duration: 200ms;
        }
        .option-btn:hover:enabled {
            background-color: #e3f2fd;
        }
        .option-btn:focus:enabled {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .option-btn:disabled {
            cursor: not-allowed;
        }

        /* Feedback and Error Messages */
        .feedback-text {
            margin-top: 1rem;
            font-weight: 500;
            font-size: 0.875rem;
        }
        .feedback-text.correct {
            color: #10b981;
        }
        .feedback-text.incorrect {
            color: #ef4444;
        }
        .error-message {
            color: #ef4444;
            text-align: center;
            font-weight: 500;
            margin-top: 1rem;
        }

        .explanation-btn {
            margin-top: 1rem;
            background-color: #2c7be5;
            color: #ffffff;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: none; /* Initially hidden */
        }

        .explanation-text {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f1f5f9;
            border-left: 4px solid #3b82f6;
            border-radius: 4px;
            font-size: 0.875rem;
            color: #334155;
            display: none; /* Initially hidden */
        }
        .explanation-text.loading-text {
            color: #64748b;
        }
        .clear-btn {
            margin-top: 2rem;
            width: 100%;
            background-color: #ef4444;
            color: #ffffff;
            font-weight: 600;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition-property: background-color;
            transition-duration: 200ms;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .clear-btn:hover {
            background-color: #dc2626;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="title">MCQ Quiz Generator</h1>
            <p class="subtitle">Paste your notes below to generate multiple-choice questions instantly.</p>
        </header>

        <!-- Input Section -->
        <div class="input-section">
            <textarea id="notes-input" class="custom-textarea" placeholder="Paste your study notes here..."></textarea>
            <button id="generate-btn" class="generate-btn">
                Generate Questions
            </button>
        </div>

        <!-- Loading and Results Section -->
        <div id="status-container" class="status-container">
            <div id="loading-indicator" class="loading-spinner"></div>
            <p id="status-message">Generating your quiz...</p>
        </div>

        <div id="quiz-container" class="quiz-container">
            <!-- Questions will be dynamically inserted here -->
        </div>
        
        <button id="clear-btn" class="clear-btn" style="display: none;">Clear All</button>

        <div id="error-message" class="error-message"></div>
    </div>

    <script type="module">
        const notesInput = document.getElementById('notes-input');
        const generateBtn = document.getElementById('generate-btn');
        const statusContainer = document.getElementById('status-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const statusMessage = document.getElementById('status-message');
        const quizContainer = document.getElementById('quiz-container');
        const errorMessage = document.getElementById('error-message');
        const clearBtn = document.getElementById('clear-btn');

        let isGenerating = false;
        let originalNotes = '';

        generateBtn.addEventListener('click', async () => {
            if (isGenerating) return;

            const notes = notesInput.value.trim();
            if (!notes) {
                displayMessage("Please paste some notes to get started.", "error");
                return;
            }
            originalNotes = notes;

            // Clear previous state
            quizContainer.innerHTML = '';
            errorMessage.style.display = 'none';
            generateBtn.disabled = true;
            isGenerating = true;
            statusContainer.style.display = 'flex';
            clearBtn.style.display = 'none';

            try {
                // The prompt for the LLM. It's designed to be very specific about the required JSON format.
                const userPrompt = `Generate 5 multiple-choice questions (MCQs) from the following notes. Each question should have one correct answer and three incorrect options. The output must be a single JSON array of objects. Each object should have the keys: "question" (string), "options" (array of 4 strings), and "correctAnswer" (string, which is the correct option).

Notes:
${notes}`;

                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "question": { "type": "STRING" },
                                    "options": {
                                        "type": "ARRAY",
                                        "items": { "type": "STRING" },
                                        "minItems": 4,
                                        "maxItems": 4
                                    },
                                    "correctAnswer": { "type": "STRING" }
                                }
                            }
                        }
                    }
                };
                
                let response;
                let retries = 0;
                const maxRetries = 3;
                while (retries < maxRetries) {
                    try {
                        response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) break;
                    } catch (error) {
                        console.error('Fetch attempt failed:', error);
                        // Implement exponential backoff
                        await new Promise(res => setTimeout(res, Math.pow(2, retries) * 1000));
                        retries++;
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error(`API request failed with status: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                    throw new Error('No content returned from the model.');
                }
                
                let questions;
                try {
                    const jsonText = candidate.content.parts[0].text;
                    questions = JSON.parse(jsonText);
                } catch (jsonError) {
                    console.error("Failed to parse JSON:", jsonError);
                    console.error("Raw JSON text:", candidate.content.parts[0].text);
                    throw new Error("Failed to parse the quiz data. Please try again with different notes.");
                }

                questions.forEach((q, index) => {
                    const questionCard = document.createElement('div');
                    questionCard.className = 'question-card';
                    questionCard.innerHTML = `
                        <p class="question-text">${index + 1}. ${q.question}</p>
                        <div class="options-grid">
                            ${q.options.map(option => `
                                <button data-answer="${option}" class="option-btn">${option}</button>
                            `).join('')}
                        </div>
                        <p class="feedback-text" style="display: none;"></p>
                        <button class="explanation-btn" data-question-index="${index}">âœ¨ Get Explanation</button>
                        <div class="explanation-text"></div>
                    `;
                    
                    const explanationBtn = questionCard.querySelector('.explanation-btn');
                    explanationBtn.addEventListener('click', async () => {
                        explanationBtn.disabled = true;
                        const explanationTextEl = questionCard.querySelector('.explanation-text');
                        explanationTextEl.style.display = 'block';
                        explanationTextEl.textContent = 'Generating explanation...';
                        explanationTextEl.className += ' loading-text';

                        const explanationPrompt = `Using the following notes, provide a concise explanation for why "${q.correctAnswer}" is the correct answer to the question: "${q.question}"

Notes:
${originalNotes}`;

                        try {
                            const explanationPayload = {
                                contents: [{ parts: [{ text: explanationPrompt }] }]
                            };

                            let explanationResponse;
                            let explanationRetries = 0;
                            const maxExplanationRetries = 3;
                            while (explanationRetries < maxExplanationRetries) {
                                try {
                                    explanationResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(explanationPayload)
                                    });
                                    if (explanationResponse.ok) break;
                                } catch (error) {
                                    console.error('Explanation fetch attempt failed:', error);
                                    await new Promise(res => setTimeout(res, Math.pow(2, explanationRetries) * 1000));
                                    explanationRetries++;
                                }
                            }

                            if (!explanationResponse || !explanationResponse.ok) {
                                throw new Error(`API request failed with status: ${explanationResponse.status}`);
                            }

                            const explanationResult = await explanationResponse.json();
                            const explanationContent = explanationResult.candidates?.[0]?.content?.parts?.[0]?.text;

                            if (explanationContent) {
                                explanationTextEl.textContent = explanationContent;
                            } else {
                                explanationTextEl.textContent = "Could not generate an explanation.";
                            }
                        } catch (err) {
                            console.error("Failed to get explanation:", err);
                            explanationTextEl.textContent = "Error generating explanation. Please try again.";
                        } finally {
                            explanationTextEl.classList.remove('loading-text');
                        }
                    });
                    
                    questionCard.querySelectorAll('.option-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const selectedAnswer = e.target.dataset.answer;
                            const feedbackText = questionCard.querySelector('.feedback-text');
                            
                            // Disable all buttons for this question
                            questionCard.querySelectorAll('.option-btn').forEach(b => {
                                b.disabled = true;
                            });
                            explanationBtn.style.display = 'block';

                            const correct = selectedAnswer === q.correctAnswer;
                            
                            if (correct) {
                                e.target.style.backgroundColor = '#d1f1e1';
                                e.target.style.borderColor = '#10b981';
                                feedbackText.textContent = "Correct!";
                                feedbackText.className += ' correct';
                            } else {
                                e.target.style.backgroundColor = '#fce8e8';
                                e.target.style.borderColor = '#ef4444';
                                feedbackText.textContent = "Incorrect. The correct answer was: " + q.correctAnswer;
                                feedbackText.className += ' incorrect';

                                // Find and highlight the correct answer
                                questionCard.querySelectorAll('.option-btn').forEach(b => {
                                    if (b.dataset.answer === q.correctAnswer) {
                                        b.style.backgroundColor = '#d1f1e1';
                                        b.style.borderColor = '#10b981';
                                    }
                                });
                            }
                            feedbackText.style.display = 'block';
                        });
                    });
                    
                    quizContainer.appendChild(questionCard);
                });
                
                clearBtn.style.display = 'block';

            } catch (err) {
                console.error("Failed to generate quiz:", err);
                displayMessage("An error occurred. Please try again.", "error");
            } finally {
                statusContainer.style.display = 'none';
                generateBtn.disabled = false;
                isGenerating = false;
            }
        });

        clearBtn.addEventListener('click', () => {
            notesInput.value = '';
            quizContainer.innerHTML = '';
            errorMessage.style.display = 'none';
            clearBtn.style.display = 'none';
            notesInput.focus();
        });

        function displayMessage(message, type = "info") {
            const el = type === "error" ? errorMessage : statusMessage;
            el.textContent = message;
            el.style.display = 'block';
            if (type === "info") {
                statusContainer.style.display = 'flex';
            }
        }
    </script>
</body>
</html>
